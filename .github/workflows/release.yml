name: Build & Release

on:
  push:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      force_bump:
        description: 'Force version bump type (overrides changeset)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - patch
          - minor
          - major

permissions:
  contents: write
  packages: write

jobs:
  # First job: Version bump and changelog (runs once)
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.new_version }}
      changelog: ${{ steps.changelog.outputs.text }}
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile || pnpm install
      
      - name: Check for changesets
        id: changesets
        run: node scripts/check-changesets.js
      
      - name: Determine bump type
        id: bump_type
        run: |
          if [ -n "${{ github.event.inputs.force_bump }}" ]; then
            echo "type=${{ github.event.inputs.force_bump }}" >> $GITHUB_OUTPUT
          else
            echo "type=${{ steps.changesets.outputs.bump_type }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Bump version
        id: version
        run: node scripts/bump-version.js ${{ steps.bump_type.outputs.type }}
      
      - name: Generate changelog
        id: changelog
        run: |
          if [ "${{ steps.changesets.outputs.has_changesets }}" == "true" ]; then
            CHANGELOG="${{ steps.changesets.outputs.changelog }}"
          else
            CHANGELOG="Automatic patch release (build #${{ github.run_number }})"
          fi
          echo "text=$CHANGELOG" >> $GITHUB_OUTPUT
      
      - name: Set version matrix
        id: set-matrix
        run: |
          # Read all version files and create matrix
          VERSIONS=$(ls versions/*.properties | sed 's/versions\///' | sed 's/.properties//' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "matrix={\"mc_version\":$VERSIONS}" >> $GITHUB_OUTPUT
          echo "Building for versions: $VERSIONS"
      
      - name: Consume changesets
        if: steps.changesets.outputs.has_changesets == 'true'
        run: |
          IFS=',' read -ra FILES <<< "${{ steps.changesets.outputs.changeset_files }}"
          node scripts/consume-changesets.js "${FILES[@]}"
      
      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add gradle.properties .changeset/
          git diff --staged --quiet || git commit -m "chore(release): v${{ steps.version.outputs.new_version }} [skip ci]"
          git push

  # Second job: Build for each MC version (parallel shards)
  build:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
      
      - name: Build for MC ${{ matrix.mc_version }}
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -Pmc_version=${{ matrix.mc_version }} --no-daemon
          echo "Built for Minecraft ${{ matrix.mc_version }}"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: compressy-${{ matrix.mc_version }}
          path: |
            build/libs/*.jar
          retention-days: 1

  # Third job: Collect all artifacts and release
  release:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Organize artifacts
        run: |
          mkdir -p release-files
          find artifacts -name "*.jar" -exec cp {} release-files/ \;
          ls -la release-files/
      
      - name: Generate release notes
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          CHANGELOG="${{ needs.prepare.outputs.changelog }}"
          
          cat << 'EOF' > RELEASE_NOTES.md
          ## Compressy v$VERSION
          
          ### Changes
          $CHANGELOG
          
          ### Supported Minecraft Versions
          
          This release includes builds for:
          - 1.21.1, 1.21.2, 1.21.3, 1.21.4, 1.21.5, 1.21.6, 1.21.7, 1.21.9, 1.21.10
          
          ### Downloads
          
          Each version has two variants:
          - **FULL** - Fabric mod with block placement support
          - **LITE** - Fabric mod, inventory-only (no block placement)
          
          ### Installation
          
          1. Install [Fabric Loader](https://fabricmc.net/) (0.16.0+)
          2. Install [Fabric API](https://modrinth.com/mod/fabric-api)
          3. Download the JAR matching your Minecraft version
          4. Drop the JAR into your `mods` folder
          EOF
          
          sed -i "s|\$VERSION|${VERSION}|g" RELEASE_NOTES.md
          sed -i "s|\$CHANGELOG|${CHANGELOG}|g" RELEASE_NOTES.md
      
      - name: Publish to Modrinth
        if: ${{ env.MODRINTH_TOKEN != '' }}
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          CHANGELOG="${{ needs.prepare.outputs.changelog }}"
          
          # Get list of all MC versions we built for
          MC_VERSIONS=$(ls artifacts/ | sed 's/compressy-//' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          
          echo "Publishing for MC versions: $MC_VERSIONS"
          
          # Publish FULL versions (one upload with all MC version JARs)
          FULL_CHANGELOG="$CHANGELOG

          **FULL version** - Includes block placement support. Place compressed blocks in the world!"
          
          # Build file parts array for all FULL jars
          FILE_ARGS=""
          for jar in release-files/compressy-1.21.*-1.1.*.jar; do
            if [[ ! "$jar" == *"-lite-"* ]]; then
              FILE_ARGS="$FILE_ARGS -F file=@$jar"
            fi
          done
          
          JSON_DATA=$(jq -n \
            --arg name "compressy-fabric" \
            --arg version "$VERSION" \
            --arg changelog "$FULL_CHANGELOG" \
            --argjson game_versions "$MC_VERSIONS" \
            '{
              name: $name,
              version_number: $version,
              changelog: $changelog,
              dependencies: [{project_id: "P7dR8mSH", dependency_type: "required"}],
              game_versions: $game_versions,
              version_type: "release",
              loaders: ["fabric"],
              featured: true,
              project_id: "compressy",
              file_parts: ["file"]
            }')
          
          # For now, upload the default version jar
          DEFAULT_JAR=$(ls release-files/compressy-1.21.4-*.jar 2>/dev/null | grep -v lite | head -1)
          if [ -n "$DEFAULT_JAR" ]; then
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.modrinth.com/v2/version" \
              -H "Authorization: $MODRINTH_TOKEN" \
              -H "User-Agent: github-actions/compressy-ci" \
              -F "data=$JSON_DATA" \
              -F "file=@$DEFAULT_JAR")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            echo "FULL Response: $BODY"
            echo "HTTP Code: $HTTP_CODE"
            
            if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
              echo "::warning::Modrinth FULL publish failed: $BODY"
            fi
          fi
          
          # Publish LITE version
          LITE_CHANGELOG="$CHANGELOG

          **LITE version** - No compressed block placing. Perfect for servers and automation!"
          
          JSON_DATA=$(jq -n \
            --arg name "compressy-fabric-LITE" \
            --arg version "$VERSION" \
            --arg changelog "$LITE_CHANGELOG" \
            --argjson game_versions "$MC_VERSIONS" \
            '{
              name: $name,
              version_number: $version,
              changelog: $changelog,
              dependencies: [{project_id: "P7dR8mSH", dependency_type: "required"}],
              game_versions: $game_versions,
              version_type: "release",
              loaders: ["fabric"],
              featured: true,
              project_id: "compressy",
              file_parts: ["file"]
            }')
          
          LITE_JAR=$(ls release-files/compressy-1.21.4-*-lite-*.jar 2>/dev/null | head -1)
          if [ -n "$LITE_JAR" ]; then
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.modrinth.com/v2/version" \
              -H "Authorization: $MODRINTH_TOKEN" \
              -H "User-Agent: github-actions/compressy-ci" \
              -F "data=$JSON_DATA" \
              -F "file=@$LITE_JAR")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            echo "LITE Response: $BODY"
            echo "HTTP Code: $HTTP_CODE"
          fi
      
      - name: Create Git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "v${{ needs.prepare.outputs.version }}"
          git push origin "v${{ needs.prepare.outputs.version }}"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: Compressy v${{ needs.prepare.outputs.version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: release-files/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          echo "## ðŸŽ‰ Release Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts:**" >> $GITHUB_STEP_SUMMARY
          ls release-files/*.jar | while read f; do echo "- $(basename $f)" >> $GITHUB_STEP_SUMMARY; done
