name: Build & Release

on:
  push:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      force_bump:
        description: 'Force version bump type (overrides changeset)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - patch
          - minor
          - major

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile || pnpm install
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
      
      - name: Check for changesets
        id: changesets
        run: node scripts/check-changesets.js
      
      - name: Determine bump type
        id: bump_type
        run: |
          if [ -n "${{ github.event.inputs.force_bump }}" ]; then
            echo "type=${{ github.event.inputs.force_bump }}" >> $GITHUB_OUTPUT
            echo "Using forced bump type: ${{ github.event.inputs.force_bump }}"
          else
            echo "type=${{ steps.changesets.outputs.bump_type }}" >> $GITHUB_OUTPUT
            echo "Using changeset bump type: ${{ steps.changesets.outputs.bump_type }}"
          fi
      
      - name: Bump version
        id: version
        run: node scripts/bump-version.js ${{ steps.bump_type.outputs.type }}
      
      - name: Build with Gradle
        run: |
          chmod +x ./gradlew
          ./gradlew build --no-daemon
      
      - name: Consume changesets
        if: steps.changesets.outputs.has_changesets == 'true'
        run: |
          IFS=',' read -ra FILES <<< "${{ steps.changesets.outputs.changeset_files }}"
          node scripts/consume-changesets.js "${FILES[@]}"
      
      - name: Generate changelog
        id: changelog
        run: |
          if [ "${{ steps.changesets.outputs.has_changesets }}" == "true" ]; then
            CHANGELOG="${{ steps.changesets.outputs.changelog }}"
          else
            CHANGELOG="Automatic patch release (build #${{ github.run_number }})"
          fi
          echo "text=$CHANGELOG" >> $GITHUB_OUTPUT
          
          VERSION="${{ steps.version.outputs.new_version }}"
          
          cat << 'EOF' > RELEASE_NOTES.md
          ## Compressy v$VERSION
          
          ### Changes
          $CHANGELOG
          
          ### Supported Minecraft Version
          - **1.21.11**
          
          ### Downloads
          | File | Description |
          |------|-------------|
          | `compressy-1.21.11-v$VERSION.jar` | **FULL** - Fabric mod with block placement support |
          | `compressy-1.21.11-lite-v$VERSION.jar` | **LITE** - Fabric mod, inventory-only (no block placement) |
          
          ### Installation
          1. Install [Fabric Loader](https://fabricmc.net/) (0.18.3+)
          2. Install [Fabric API](https://modrinth.com/mod/fabric-api)
          3. Drop the JAR into your `mods` folder
          EOF
          
          sed -i "s|\$VERSION|${VERSION}|g" RELEASE_NOTES.md
          sed -i "s|\$CHANGELOG|${CHANGELOG}|g" RELEASE_NOTES.md
      
      # Modrinth Publishing
      - name: Publish FULL version to Modrinth
        if: ${{ env.MODRINTH_TOKEN != '' }}
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.new_version }}"
          CHANGELOG="${{ steps.changelog.outputs.text }}

          **FULL version** - Includes block placement support. Place compressed blocks in the world!"
          
          JSON_DATA=$(jq -n \
            --arg name "compressy-fabric" \
            --arg version "$VERSION" \
            --arg changelog "$CHANGELOG" \
            '{
              name: $name,
              version_number: $version,
              changelog: $changelog,
              dependencies: [{project_id: "P7dR8mSH", dependency_type: "required"}],
              game_versions: ["1.21.11"],
              version_type: "release",
              loaders: ["fabric"],
              featured: true,
              project_id: "compressy",
              file_parts: ["file"]
            }')
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.modrinth.com/v2/version" \
            -H "Authorization: $MODRINTH_TOKEN" \
            -H "User-Agent: github-actions/compressy-ci" \
            -F "data=$JSON_DATA" \
            -F "file=@build/libs/compressy-1.21.11-v${VERSION}.jar")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "::error::Modrinth FULL publish failed with HTTP $HTTP_CODE: $BODY"
            exit 1
          fi
      
      - name: Publish LITE version to Modrinth
        if: ${{ env.MODRINTH_TOKEN != '' }}
        env:
          MODRINTH_TOKEN: ${{ secrets.MODRINTH_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.new_version }}"
          CHANGELOG="${{ steps.changelog.outputs.text }}

          **LITE version** - No compressed block placing supported. Perfect for servers and automation-focused gameplay with zero overhead!"
          
          JSON_DATA=$(jq -n \
            --arg name "compressy-fabric-LITE" \
            --arg version "$VERSION" \
            --arg changelog "$CHANGELOG" \
            '{
              name: $name,
              version_number: $version,
              changelog: $changelog,
              dependencies: [{project_id: "P7dR8mSH", dependency_type: "required"}],
              game_versions: ["1.21.11"],
              version_type: "release",
              loaders: ["fabric"],
              featured: true,
              project_id: "compressy",
              file_parts: ["file"]
            }')
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.modrinth.com/v2/version" \
            -H "Authorization: $MODRINTH_TOKEN" \
            -H "User-Agent: github-actions/compressy-ci" \
            -F "data=$JSON_DATA" \
            -F "file=@build/libs/compressy-1.21.11-lite-v${VERSION}.jar")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response: $BODY"
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
            echo "::error::Modrinth LITE publish failed with HTTP $HTTP_CODE: $BODY"
            exit 1
          fi
      
      # Git commits and GitHub Release AFTER Modrinth succeeds
      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add gradle.properties .changeset/
          git diff --staged --quiet || git commit -m "chore(release): v${{ steps.version.outputs.new_version }} [skip ci]"
          git push
      
      - name: Create Git tag
        run: |
          git tag "v${{ steps.version.outputs.new_version }}"
          git push origin "v${{ steps.version.outputs.new_version }}"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.new_version }}
          name: Compressy v${{ steps.version.outputs.new_version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            build/libs/compressy-1.21.11-v${{ steps.version.outputs.new_version }}.jar
            build/libs/compressy-1.21.11-lite-v${{ steps.version.outputs.new_version }}.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          echo "## ðŸŽ‰ Release Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Minecraft:** 1.21.11" >> $GITHUB_STEP_SUMMARY
          echo "**Bump Type:** ${{ steps.bump_type.outputs.type }}" >> $GITHUB_STEP_SUMMARY
