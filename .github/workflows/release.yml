name: Build & Release

on:
  push:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      force_bump:
        description: 'Force version bump type (overrides changeset)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - patch
          - minor
          - major

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile || pnpm install
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
      
      - name: Check for changesets
        id: changesets
        run: node scripts/check-changesets.js
      
      - name: Determine bump type
        id: bump_type
        run: |
          if [ -n "${{ github.event.inputs.force_bump }}" ]; then
            echo "type=${{ github.event.inputs.force_bump }}" >> $GITHUB_OUTPUT
            echo "Using forced bump type: ${{ github.event.inputs.force_bump }}"
          else
            echo "type=${{ steps.changesets.outputs.bump_type }}" >> $GITHUB_OUTPUT
            echo "Using changeset bump type: ${{ steps.changesets.outputs.bump_type }}"
          fi
      
      - name: Bump version
        id: version
        run: node scripts/bump-version.js ${{ steps.bump_type.outputs.type }}
      
      - name: Build with Gradle
        run: |
          chmod +x ./gradlew
          ./gradlew build --no-daemon
      
      - name: Consume changesets
        if: steps.changesets.outputs.has_changesets == 'true'
        run: |
          IFS=',' read -ra FILES <<< "${{ steps.changesets.outputs.changeset_files }}"
          node scripts/consume-changesets.js "${FILES[@]}"
      
      - name: Generate changelog
        id: changelog
        run: |
          if [ "${{ steps.changesets.outputs.has_changesets }}" == "true" ]; then
            CHANGELOG="${{ steps.changesets.outputs.changelog }}"
          else
            CHANGELOG="Automatic patch release (build #${{ github.run_number }})"
          fi
          echo "text=$CHANGELOG" >> $GITHUB_OUTPUT
          
          # Create release notes
          cat << 'EOF' > RELEASE_NOTES.md
          ## Compressy v${{ steps.version.outputs.new_version }}
          
          ### Changes
          $CHANGELOG
          
          ### Downloads
          
          | File | Description |
          |------|-------------|
          | `compressy-${{ steps.version.outputs.new_version }}.jar` | **FULL** - Fabric mod with block placement support |
          | `compressy-lite-${{ steps.version.outputs.new_version }}.jar` | **LITE** - Fabric mod, inventory-only (no block placement) |
          | `compressy-datapack-${{ steps.version.outputs.new_version }}.zip` | **Datapack** - Standalone, no Fabric required |
          
          ### Installation
          
          **Fabric Mod (FULL or LITE):**
          1. Install [Fabric Loader](https://fabricmc.net/) (0.18.2+)
          2. Install [Fabric API](https://modrinth.com/mod/fabric-api)
          3. Drop the JAR into your `mods` folder
          
          **Datapack:**
          1. Drop the ZIP into your world's `datapacks` folder
          2. Run `/reload` or restart the world
          EOF
          
          # Replace variable in file
          sed -i "s|\$CHANGELOG|${CHANGELOG}|g" RELEASE_NOTES.md
          
          echo "Generated release notes"
      
      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add gradle.properties .changeset/
          git diff --staged --quiet || git commit -m "chore(release): v${{ steps.version.outputs.new_version }} [skip ci]"
          git push
      
      - name: Create Git tag
        run: |
          git tag "v${{ steps.version.outputs.new_version }}"
          git push origin "v${{ steps.version.outputs.new_version }}"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.new_version }}
          name: Compressy v${{ steps.version.outputs.new_version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            build/libs/compressy-${{ steps.version.outputs.new_version }}.jar
            build/libs/compressy-lite-${{ steps.version.outputs.new_version }}.jar
            build/datapacks/compressy-datapack-${{ steps.version.outputs.new_version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # Modrinth Publishing (only if MODRINTH_TOKEN is set)
      # Publishes 3 separate versions: FULL, LITE, and Datapack
      
      - name: Publish FULL version to Modrinth
        if: ${{ secrets.MODRINTH_TOKEN != '' }}
        run: |
          CHANGELOG="${{ steps.changelog.outputs.text }}

          **FULL version** - Includes block placement support. Place compressed blocks in the world!"
          
          curl -X POST "https://api.modrinth.com/v2/version" \
            -H "Authorization: ${{ secrets.MODRINTH_TOKEN }}" \
            -H "User-Agent: github-actions/compressy-ci" \
            -F "data={
              \"name\": \"compressy-fabric\",
              \"version_number\": \"${{ steps.version.outputs.new_version }}\",
              \"changelog\": $(echo "$CHANGELOG" | jq -Rs .),
              \"dependencies\": [{\"project_id\": \"P7dR8mSH\", \"dependency_type\": \"required\"}],
              \"game_versions\": [\"1.21.11\"],
              \"version_type\": \"release\",
              \"loaders\": [\"fabric\"],
              \"featured\": true,
              \"project_id\": \"compressy\"
            }" \
            -F "file=@build/libs/compressy-${{ steps.version.outputs.new_version }}.jar"
      
      - name: Publish LITE version to Modrinth
        if: ${{ secrets.MODRINTH_TOKEN != '' }}
        run: |
          CHANGELOG="${{ steps.changelog.outputs.text }}

          **LITE version** - No compressed block placing supported. Perfect for servers and automation-focused gameplay with zero overhead!"
          
          curl -X POST "https://api.modrinth.com/v2/version" \
            -H "Authorization: ${{ secrets.MODRINTH_TOKEN }}" \
            -H "User-Agent: github-actions/compressy-ci" \
            -F "data={
              \"name\": \"compressy-fabric-LITE\",
              \"version_number\": \"${{ steps.version.outputs.new_version }}\",
              \"changelog\": $(echo "$CHANGELOG" | jq -Rs .),
              \"dependencies\": [{\"project_id\": \"P7dR8mSH\", \"dependency_type\": \"required\"}],
              \"game_versions\": [\"1.21.11\"],
              \"version_type\": \"release\",
              \"loaders\": [\"fabric\"],
              \"featured\": true,
              \"project_id\": \"compressy\"
            }" \
            -F "file=@build/libs/compressy-lite-${{ steps.version.outputs.new_version }}.jar"
      
      - name: Publish Datapack to Modrinth
        if: ${{ secrets.MODRINTH_TOKEN != '' }}
        run: |
          CHANGELOG="${{ steps.changelog.outputs.text }}

          **Standalone Datapack** - Works without Fabric! Just drop in your world's datapacks folder. Provides recipes only (no custom block placement or tooltips)."
          
          curl -X POST "https://api.modrinth.com/v2/version" \
            -H "Authorization: ${{ secrets.MODRINTH_TOKEN }}" \
            -H "User-Agent: github-actions/compressy-ci" \
            -F "data={
              \"name\": \"compressy-datapack\",
              \"version_number\": \"${{ steps.version.outputs.new_version }}\",
              \"changelog\": $(echo "$CHANGELOG" | jq -Rs .),
              \"dependencies\": [],
              \"game_versions\": [\"1.21.11\"],
              \"version_type\": \"release\",
              \"loaders\": [\"datapack\"],
              \"featured\": true,
              \"project_id\": \"compressy\"
            }" \
            -F "file=@build/datapacks/compressy-datapack-${{ steps.version.outputs.new_version }}.zip"
      
      - name: Summary
        run: |
          echo "## ðŸŽ‰ Release Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Bump Type:** ${{ steps.bump_type.outputs.type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Changesets Used:** ${{ steps.changesets.outputs.has_changesets }}" >> $GITHUB_STEP_SUMMARY
